---
title: gradle publish && company use
date: 2018-12-28 17:06:27
tags:
categories:
-   java
-   gradle
---

gradle插件编写 && 上传 && 使用

<!--more-->

# 插件编写

> [官网教程](https://docs.gradle.org/current/userguide/custom_plugins.html)

# 打包上传(普通jar包)
## 账号密码与项目分离
在环境变量 `GRADLE_USER_HOME`(一般为 `${user.home}/.gradle`)下新建 gradle.properties, 里面的配置可被build.gradle引用

## 插件引用
```groovy
    apply plugin: 'maven'
    apply plugin: 'maven-publish'
```

## kotlin下发生的奇怪问题
```groovy
    bootJar.enabled = false
    
    jar{
        enabled = true
    }
```
## 打包源码
```groovy
    task sourcetype(type: Jar) {
        classifier = 'sources'
        from sourceSets.main.allSource
    }
    
    artifacts{
        archives jar
        archives sourcetype
    }
```

## 上传到maven仓库

```groovy
    uploadArchives {
        repositories.mavenDeployer {
            repository(url: 'http://192.168.103.133:8080/repository/scooper-trial/') {// 仓库地址
// 这里配置上传账户的用户名和密码
                authentication(userName: scooperTrialUser, password: scooperTrialPwd)
            }
            
            pom.version = project.version
            pom.groupId = project.group
            pom.artifactId = project.name
        }
    }
```
## 项目全部配置
```groovy
/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Kotlin library project to get you started.
 */

plugins {
    // Apply the Kotlin JVM plugin to add support for Kotlin on the JVM.
    id 'org.jetbrains.kotlin.jvm' version '1.3.11'
    id 'org.springframework.boot' version '2.1.3.RELEASE'
    id 'maven'
    id 'maven-publish' //该插件可以将打包的jar发送到maven库
}

apply plugin: 'io.spring.dependency-management'

version = "1.0.0.0-beta11"
group = "cn.com.scooper"


repositories {
    // Use jcenter for resolving your dependencies.
    // You can declare any Maven/Ivy/file repository here.
    mavenCentral()
    jcenter()
    maven {
        url = 'http://192.168.103.133:8080/repository/internal'
    }
}

dependencies {
    // Use the Kotlin JDK 8 standard library.
    implementation 'org.jetbrains.kotlin:kotlin-stdlib-jdk8'

    // Use the Kotlin test library.
    testImplementation 'org.jetbrains.kotlin:kotlin-test'

    // Use the Kotlin JUnit integration.
    testImplementation 'org.jetbrains.kotlin:kotlin-test-junit'
}

dependencies {
    compile "org.springframework.boot:spring-boot-starter"
}

dependencies {
    compile project(":kiswich-spring-boot-starter")
    compile project(":kiswich-spring-boot-base")
    compile project(":kiswich-spring-boot-autoconfigure")
}

allprojects {
    configurations {
        modules
        compile.extendsFrom(modules)
    }
}

subprojects {
    apply plugin: 'org.jetbrains.kotlin.jvm'
    apply plugin: 'java'
    apply plugin: 'maven'
    apply plugin: 'maven-publish'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'

    repositories {
        maven {
            url = 'http://192.168.103.133:8080/repository/internal'
        }
        mavenCentral()
    }

    group = rootProject.group
    version = rootProject.version

    bootJar.enabled = false
    
    jar{
        enabled = true
//        archiveName = "${baseName}-${appendix}-${version}.${extension}"
    }

    task sourcetype(type: Jar) {
        classifier = 'sources'
        from sourceSets.main.allSource
    }
    
    artifacts{
        archives jar
        archives sourcetype
    }

    dependencies {
        // Use the Kotlin JDK 8 standard library.
        implementation 'org.jetbrains.kotlin:kotlin-stdlib-jdk8'

        // Use the Kotlin test library.
        testImplementation 'org.jetbrains.kotlin:kotlin-test'

        // Use the Kotlin JUnit integration.
        testImplementation 'org.jetbrains.kotlin:kotlin-test-junit'
    }

    dependencies {
        compile "org.springframework.boot:spring-boot-starter"
        compile 'org.springframework.boot:spring-boot-starter-web'
    }

    dependencies {
        compile 'cn.com.scooper.common:scooper-common:1.0.24'
    }

    uploadArchives {
        repositories.mavenDeployer {
            repository(url: 'http://192.168.103.133:8080/repository/scooper-trial/') {// 仓库地址
// 这里配置上传账户的用户名和密码
                authentication(userName: scooperTrialUser, password: scooperTrialPwd)
            }
            
            pom.version = project.version
            pom.groupId = project.group
            pom.artifactId = project.name
        }
    }
}

bootJar.enabled = false
jar.enabled = true

```

# 打包上传插件
与前者不用的是，这里将用gradle自带的publish上传，因为maven只是把jar包上传了，并没有上传插件的信息


## 配置插件信息
```groovy
gradlePlugin {
    plugins {
        ScooperPackPlugin {
            id = "scooper.pack"
            implementationClass = 'cn.com.scooper.packplugin.MainPlugin'
        }

    }
}
```

## 配置上传信息
```groovy
task sourcesJar(type: Jar) {
    from sourceSets.main.allSource
    classifier = 'sources'
}

publishing {
    publications {
        plugin(MavenPublication) {
            from components.java
            group project.group
            artifactId project.rootProject.name
            version project.version


            artifact jar
            artifact sourcesJar
        
        }

    }
    repositories {
        maven {
            url = 'http://192.168.103.133:8080/repository/scooper-trial/'
            credentials {
                username scooperTrialUser
                password scooperTrialPwd
            }
        }
    }
}
```

## 执行 task publish